<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout :: head"></head>
<body>
<div th:replace="layout :: nav"></div>

<main class="container mt-4">
    <!-- Заголовок -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="fas fa-shopping-cart"></i> Бронирование билета</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/passenger/dashboard}">Панель пассажира</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/passenger/flights}">Рейсы</a></li>
                    <li class="breadcrumb-item active">Бронирование</li>
                </ol>
            </nav>
        </div>
        <div>
            <a th:href="@{/passenger/flights}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Назад к рейсам
            </a>
        </div>
    </div>

    <!-- Сообщения из Flash атрибутов -->
    <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${param.success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${param.error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Сообщения из модели -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Информация о рейсе -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-plane"></i> Информация о рейсе</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Номер рейса:</th>
                            <td th:text="${flight.flightNumber}">SU1001</td>
                        </tr>
                        <tr>
                            <th>Маршрут:</th>
                            <td>
                                <span th:text="${flight.departureCity}">Москва</span> →
                                <span th:text="${flight.arrivalCity}">Санкт-Петербург</span>
                            </td>
                        </tr>
                        <tr>
                            <th>Вылет:</th>
                            <td th:text="${#temporals.format(flight.departureTime, 'dd.MM.yyyy HH:mm')}">20.12.2024 08:00</td>
                        </tr>
                        <tr>
                            <th>Прибытие:</th>
                            <td th:text="${#temporals.format(flight.arrivalTime, 'dd.MM.yyyy HH:mm')}">20.12.2024 09:30</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Статус:</th>
                            <td>
                                <span th:switch="${flight.status}" class="status-badge">
                                    <span th:case="'SCHEDULED'" class="badge bg-info">По расписанию</span>
                                    <span th:case="'BOARDING'" class="badge bg-warning">Посадка</span>
                                    <span th:case="'DEPARTED'" class="badge bg-danger">Вылетел</span>
                                    <span th:case="'ARRIVED'" class="badge bg-success">Прибыл</span>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Доступно мест:</th>
                            <td>
                                <span th:if="${flight.availableSeats > 0}" class="badge bg-success">
                                    <span th:text="${flight.availableSeats}">10</span> мест
                                </span>
                                <span th:unless="${flight.availableSeats > 0}" class="badge bg-danger">
                                    Нет мест
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Всего мест:</th>
                            <td th:text="${flight.totalSeats}">180</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Форма бронирования -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-ticket-alt"></i> Форма бронирования</h5>
        </div>
        <div class="card-body">
            <!-- Простая форма с явным указанием action -->
            <form th:action="@{/passenger/tickets/book}" method="post">
                <input type="hidden" name="flightNumber" th:value="${flight.flightNumber}">
                <input type="hidden" name="price" value="5000">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="passportNumber" class="form-label">
                            <i class="fas fa-id-card"></i> Номер паспорта
                        </label>
                        <input type="text" class="form-control" id="passportNumber"
                               name="passportNumber"
                               th:value="${passenger != null ? passenger.passportNumber : ''}"
                               placeholder="Например: AB1234567"
                               required>
                        <div class="form-text">
                            Введите номер вашего паспорта
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="passengerName" class="form-label">
                            <i class="fas fa-user"></i> ФИО пассажира
                        </label>
                        <input type="text" class="form-control" id="passengerName"
                               name="passengerName"
                               th:value="${passenger != null ? passenger.user.firstName + ' ' + passenger.user.lastName : ''}"
                               placeholder="Иванов Иван Иванович"
                               required>
                        <div class="form-text">
                            Полное имя пассажира как в паспорте
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="seatNumber" class="form-label">
                            <i class="fas fa-chair"></i> Выбор места
                        </label>
                        <input type="text" class="form-control" id="seatNumber"
                               name="seatNumber"
                               placeholder="Например: 12A, 15B, 3C"
                               required>
                        <div class="form-text">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Формат места:</strong> Номер ряда + буква места (например: 12A, 15B)
                                </small>
                            </div>
                            <div class="mt-1">
                                <small class="text-muted">
                                    <strong>Занятые места:</strong>
                                    <span th:if="${not occupiedSeats.empty}">
                                        <span th:each="seat, stat : ${occupiedSeats}">
                                            <span th:text="${seat}"></span><span th:if="${not stat.last}">, </span>
                                        </span>
                                    </span>
                                    <span th:if="${occupiedSeats.empty}">
                                        Нет занятых мест
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-money-bill-wave"></i> Стоимость
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">₽</span>
                            <input type="text" class="form-control" value="5000.00" readonly>
                        </div>
                        <div class="form-text">
                            Базовая стоимость билета
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning mb-4">
                    <h6><i class="fas fa-exclamation-triangle"></i> Важная информация</h6>
                    <ul class="mb-0">
                        <li>Билет является невозвратным</li>
                        <li>Регистрация начинается за 2 часа до вылета</li>
                        <li>При посадке необходимо предъявить паспорт</li>
                        <li>Багаж: 1 место до 20 кг бесплатно</li>
                    </ul>
                </div>

                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="termsAgreement" required>
                    <label class="form-check-label" for="termsAgreement">
                        Я согласен с условиями перевозки, политикой возврата и обработкой персональных данных
                    </label>
                </div>

                <div class="d-flex justify-content-between">
                    <a th:href="@{/passenger/flights}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Отмена
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-check"></i> Подтвердить бронирование
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<div th:replace="layout :: footer"></div>

<style>
    .status-badge .badge {
        font-size: 0.9em;
        padding: 0.4em 0.8em;
    }

    .table-borderless th {
        font-weight: 600;
        color: #495057;
    }

    .btn-lg {
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Валидация формы
        const form = document.querySelector('form');
        const termsCheckbox = document.getElementById('termsAgreement');
        const submitButton = form.querySelector('button[type="submit"]');

        function validateForm() {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                }
            });

            if (!termsCheckbox.checked) {
                isValid = false;
            }

            submitButton.disabled = !isValid;
            return isValid;
        }

        // Проверяем форму при изменении
        form.addEventListener('input', validateForm);
        termsCheckbox.addEventListener('change', validateForm);

        // Валидация при отправке
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                alert('Пожалуйста, заполните все обязательные поля и согласитесь с условиями.');
                return false;
            }
            return true;
        });

        // Инициализация
        validateForm();
    });
</script>
</body>
</html>